<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Futuristic Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Round" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #e2e8f0;
      height: 100%;
    }

    .glass {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .glow {
      animation: glowPulse 3s infinite ease-in-out;
    }

    @keyframes glowPulse {
      0%, 100% { text-shadow: 0 0 10px rgba(255,255,255,0.2); }
      50% { text-shadow: 0 0 20px rgba(255,255,255,0.4); }
    }

    #loadingSpinner div {
      border-bottom-color: transparent;
    }
  </style>
</head>
<body class="p-6">

  <!-- üîÑ Loading Spinner -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 border-solid"></div>
  </div>

  <!-- ‚ö†Ô∏è Warning Message -->
  <div id="warningMessage" class="hidden mb-6 p-4 text-sm text-red-200 bg-red-800 border border-red-600 rounded-lg shadow">
    ‚ö†Ô∏è Unable to load data. Please check sheet access or network connection.
  </div>

  <!-- Header -->
  <header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-10">
    <div class="flex items-center gap-6">
      <span class="material-icons-round text-blue-400 text-[8vw] md:text-[5rem] animate-bounce">local_shipping</span>
      <div>
        <div id="pendingDispatch" class="text-[12vw] md:text-[6rem] font-black glow">0</div>
        <div class="uppercase text-sm tracking-widest text-blue-300">Pending for Dispatch</div>
      </div>
    </div>
    <div class="text-right">
      <div id="dateTime" class="text-sm text-slate-300 font-medium">Loading...</div>
      <div id="lastUpdated" class="text-xl font-bold text-white">--:-- ???</div>
    </div>
  </header>

  <!-- Region Cards -->
  <section id="regionData" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-10"></section>

  <!-- Top Contributors -->
  <section class="glass rounded-xl p-6 mb-8 shadow-lg">
    <h2 class="text-lg font-semibold mb-4 border-b border-slate-600 pb-2">Top Contributors</h2>
    <table class="w-full text-left">
      <thead>
        <tr class="text-blue-300 border-b border-slate-600">
          <th class="py-2 px-3">Region</th>
          <th class="py-2 px-3">Top Contributor</th>
        </tr>
      </thead>
      <tbody id="topContribTable"></tbody>
    </table>
  </section>

  <!-- Ageing Buckets -->
  <section class="glass rounded-xl p-6 shadow-lg">
    <h2 class="text-lg font-semibold mb-4 border-b border-slate-600 pb-2">Ageing Buckets</h2>
    <div id="ageingData" class="space-y-2"></div>
  </section>

  <script>
    const padZero = num => num < 10 ? '0' + num : num;

    const formatDateTime = input => {
      try {
        let dateObj = typeof input === 'string' && input.startsWith('Date(') ?
          new Date(...input.match(/\d+/g).map(Number)) : new Date(input);
        if (isNaN(dateObj)) return input;

        const hours = dateObj.getHours() % 12 || 12;
        const minutes = padZero(dateObj.getMinutes());
        const ampm = dateObj.getHours() >= 12 ? 'PM' : 'AM';
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        return `${hours}:${minutes} ${ampm} ${months[dateObj.getMonth()]}-${padZero(dateObj.getDate())}`;
      } catch (e) {
        return input;
      }
    };

    const updateDateTime = () => {
      const now = new Date();
      const hours = now.getHours() % 12 || 12;
      const minutes = padZero(now.getMinutes());
      const seconds = padZero(now.getSeconds());
      const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
      const dayName = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][now.getDay()];
      const month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][now.getMonth()];
      document.getElementById('dateTime').textContent = `${dayName}, ${month} ${now.getDate()} ${now.getFullYear()} | ${hours}:${minutes}:${seconds} ${ampm}`;
    };

    const animateValue = (el, start, end, duration = 1500) => {
      let startTime;
      const step = timestamp => {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        el.textContent = Math.floor(progress * (end - start) + start).toLocaleString();
        if (progress < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    };

    const fetchData = async () => {
      const spinner = document.getElementById('loadingSpinner');
      const warning = document.getElementById('warningMessage');
      spinner.style.display = 'flex';
      warning.classList.add('hidden');

      try {
        const sheetId = '1Dx2UcHhfS8BSBbPbVM_VoY7WEdIjepeGKYK8KFl-OOQ';
        const sheetName = 'Dashboard_Data';
        const range = 'A1:K20';
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}&range=${range}`;

        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        const rows = json.table.rows || [];

        if (rows.length === 0) {
          throw new Error('No data found in sheet.');
        }

        let pending = 0;
        let updated = '--:--';
        const regions = [], ageing = [];

        rows.forEach(row => {
          const r = row.c;
          if (r[5]?.v) pending = r[5].v;
          if (r[3]?.v) updated = formatDateTime(r[3].v);
          if (r[0]?.v && r[1]?.v != null) regions.push({ name: r[0].v, val: r[1].v, top: r[2]?.v || '' });
          if (r[8]?.v && r[9]?.v != null) ageing.push({ bucket: r[8].v, qty: r[9].v });
        });

        animateValue(document.getElementById('pendingDispatch'), 0, pending);
        document.getElementById('lastUpdated').textContent = updated;

        document.getElementById('regionData').innerHTML = regions.map(r => `
          <div class="glass p-4 rounded-lg text-center shadow-md">
            <div class="text-xl font-bold text-blue-200">${r.name}</div>
            <div class="text-3xl font-black text-white">${r.val}</div>
          </div>`).join('');

        document.getElementById('topContribTable').innerHTML = regions.map(r => `
          <tr class="border-b border-slate-700">
            <td class="py-2 px-3">${r.name}</td>
            <td class="py-2 px-3">${r.top}</td>
          </tr>`).join('');

        document.getElementById('ageingData').innerHTML = ageing.map(a => `
          <div class="flex justify-between text-sm border-b border-slate-600 py-1">
            <span>${a.bucket}</span>
            <span class="font-bold text-white">${a.qty}</span>
          </div>`).join('');

      } catch (e) {
        console.error('Error fetching data:', e);
        document.getElementById('lastUpdated').textContent = 'Load Failed';
        warning.classList.remove('hidden');
      } finally {
        spinner.style.display = 'none';
      }
    };

    updateDateTime();
    fetchData();
    setInterval(updateDateTime, 1000);
    setInterval(fetchData, 300000);
  </script>

</body>
</html>
